<!DOCTYPE html>
<html>
<head>
  <title>Echo Auth Test</title>
  <style>
    body {
      background: #1e1e1e;
      color: white;
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      color: #61dafb;
    }
    .status {
      padding: 15px;
      background: #333;
      margin: 10px 0;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .controls {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }
    button {
      padding: 10px 20px;
      background: #61dafb;
      color: #1e1e1e;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    button:hover {
      background: #4fa8c5;
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .success {
      background: #2d4a2b;
      border: 1px solid #4caf50;
    }
    .error {
      background: #4a2b2b;
      border: 1px solid #f44336;
    }
    .info {
      background: #2b3d4a;
      border: 1px solid #2196f3;
    }
    .token-display {
      margin-top: 10px;
      padding: 10px;
      background: #2b2b2b;
      border-radius: 3px;
      font-size: 12px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Echo Auth Test</h1>
  
  <div id="status" class="status info">Token exists: <span id="tokenStatus">false</span></div>
  
  <div class="controls">
    <button onclick="testLogin()">Test Login</button>
    <button onclick="signup()">Sign Up</button>
    <button onclick="checkAuth()">Check Auth</button>
    <button onclick="getMe()">Get Me</button>
    <button onclick="testProtected()">Test Protected</button>
    <button onclick="logout()">Logout</button>
  </div>

  <div id="log" class="status">Ready to test authentication...</div>

  <script>
    const status = document.getElementById('status');
    const tokenStatus = document.getElementById('tokenStatus');
    const log = document.getElementById('log');
    
    // Configuration
    const API_BASE = 'http://localhost:3000';
    const TOKEN_KEY = 'echo_rubicon_token';
    
    // Helper to update token status
    function updateTokenStatus() {
      const token = localStorage.getItem(TOKEN_KEY);
      tokenStatus.textContent = !!token;
      if (token) {
        status.className = 'status success';
        // Display truncated token
        const truncated = token.substring(0, 20) + '...' + token.substring(token.length - 20);
        status.innerHTML = `Token exists: true<div class="token-display">Token: ${truncated}</div>`;
      } else {
        status.className = 'status info';
        status.innerHTML = 'Token exists: false';
      }
    }
    
    // Helper to log messages
    function logMessage(message, type = 'info') {
      log.className = `status ${type}`;
      log.textContent = message;
      console.log(message);
    }
    
    // Test login with correct credentials
    async function testLogin() {
      try {
        logMessage('Attempting login...');
        const response = await fetch(`${API_BASE}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: 'test', password: '123' })
        });
        
        const data = await response.json();
        
        if (response.ok && data.token) {
          localStorage.setItem(TOKEN_KEY, data.token);
          
          // Create userInfo for MyAI compatibility
          const userInfo = {
            username: data.username,
            email: data.username,
            features: data.features || ['chat', 'streaming'],
            isAuthenticated: true
          };
          
          // Store for MyAI
          window.userInfo = userInfo;
          localStorage.setItem('echo_rubicon_userInfo', JSON.stringify(userInfo));
          
          logMessage(`Login successful! User: ${data.username}`, 'success');
          updateTokenStatus();
        } else {
          logMessage(`Login failed: ${JSON.stringify(data)}`, 'error');
        }
      } catch (err) {
        logMessage(`Login error: ${err.message}`, 'error');
      }
    }
    
    // Sign up new user
    async function signup() {
      try {
        logMessage('Attempting signup...');
        const response = await fetch(`${API_BASE}/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            username: 'newuser' + Date.now(), 
            password: 'password123' 
          })
        });
        
        const data = await response.json();
        
        if (response.ok && data.token) {
          localStorage.setItem(TOKEN_KEY, data.token);
          logMessage(`Signup successful! User: ${data.username}`, 'success');
          updateTokenStatus();
        } else {
          logMessage(`Signup failed: ${JSON.stringify(data)}`, 'error');
        }
      } catch (err) {
        logMessage(`Signup error: ${err.message}`, 'error');
      }
    }
    
    // Check authentication
    async function checkAuth() {
      const token = localStorage.getItem(TOKEN_KEY);
      
      if (!token) {
        logMessage('No token found', 'error');
        return;
      }
      
      // Note: The Rust backend doesn't have a /verify-token endpoint
      // Let's try the /me endpoint instead
      try {
        logMessage('Checking authentication...');
        const response = await fetch(`${API_BASE}/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          logMessage(`Auth valid! User: ${JSON.stringify(data)}`, 'success');
        } else {
          logMessage(`Auth check failed: ${response.status} ${response.statusText}`, 'error');
        }
      } catch (err) {
        logMessage(`Auth check error: ${err.message}`, 'error');
      }
    }
    
    // Get current user info
    async function getMe() {
      const token = localStorage.getItem(TOKEN_KEY);
      
      if (!token) {
        logMessage('No token found', 'error');
        return;
      }
      
      try {
        logMessage('Getting user info...');
        const response = await fetch(`${API_BASE}/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          logMessage(`User info: ${JSON.stringify(data, null, 2)}`, 'success');
        } else {
          logMessage(`Failed to get user info: ${response.status}`, 'error');
        }
      } catch (err) {
        logMessage(`Error getting user info: ${err.message}`, 'error');
      }
    }
    
    // Test protected endpoint
    async function testProtected() {
      const token = localStorage.getItem(TOKEN_KEY);
      
      if (!token) {
        logMessage('No token found', 'error');
        return;
      }
      
      try {
        logMessage('Testing protected endpoint...');
        const response = await fetch(`${API_BASE}/echo`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ message: 'Hello from test!' })
        });
        
        if (response.ok) {
          const data = await response.json();
          logMessage(`Protected endpoint response: ${JSON.stringify(data)}`, 'success');
        } else {
          logMessage(`Protected endpoint failed: ${response.status}`, 'error');
        }
      } catch (err) {
        logMessage(`Protected endpoint error: ${err.message}`, 'error');
      }
    }
    
    // Logout
    function logout() {
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem('echo_rubicon_userInfo');
      delete window.userInfo;
      logMessage('Logged out successfully', 'info');
      updateTokenStatus();
    }
    
    // Check auth status on load
    window.onload = function() {
      updateTokenStatus();
      
      // Check if we have a token
      const token = localStorage.getItem(TOKEN_KEY);
      if (token) {
        logMessage('Token found, checking if valid...', 'info');
        checkAuth();
      }
    };
  </script>
</body>
</html>